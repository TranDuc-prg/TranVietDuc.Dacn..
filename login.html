<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Đăng nhập | Thủ Công Việt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Quicksand:wght@500;700&display=swap');
        :root { --primary: #8d6e63; --glass-bg: rgba(255, 250, 245, 0.9); --text-dark: #4e342e; }
        body { margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; font-family: 'Quicksand', sans-serif; background: linear-gradient(135deg, #fdfbfb 0%, #eee5db 100%); }
        .box { background: var(--glass-bg); width: 100%; max-width: 400px; padding: 50px 40px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); text-align: center; }
        h2 { font-family: 'Playfair Display', serif; color: var(--text-dark); margin-bottom: 30px; }
        input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #6d4c41; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #5d4037; }
        .switch { margin-top: 20px; font-size: 14px; color: #888; }
        .switch a { color: #5d4037; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .hidden { display: none; }
        #errorMsg { margin-top: 15px; font-size: 14px; min-height: 20px; }
    </style>
</head>
<body>
<div class="box">
    <h2 id="title">Đăng nhập</h2>
    <form id="loginForm">
        <input id="loginEmail" type="email" placeholder="Email" required>
        <input id="loginPassword" type="password" placeholder="Mật khẩu" required>
        <button type="submit">Đăng nhập</button>
    </form>

    <form id="registerForm" class="hidden">
        <input id="regEmail" type="email" placeholder="Email đăng ký" required>
        <input id="regPassword" type="password" placeholder="Mật khẩu (>=6 ký tự)" required>
        <input id="regConfirm" type="password" placeholder="Xác nhận mật khẩu" required>
        <button type="submit">Đăng ký</button>
    </form>

    <div class="switch">
        <span id="toRegister">Chưa có tài khoản? <a>Đăng ký</a></span>
        <span id="toLogin" class="hidden">Đã có tài khoản? <a>Đăng nhập</a></span>
    </div>
    <div id="errorMsg"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBV4hjn3oiT9TEUzldKOloJ-W2nmNTcuRo",
        authDomain: "thucongviet-system.firebaseapp.com",
        databaseURL: "https://thucongviet-system-default-rtdb.firebaseio.com",
        projectId: "thucongviet-system",
        storageBucket: "thucongviet-system.firebasestorage.app",
        messagingSenderId: "107022520550",
        appId: "1:107022520550:web:63249a3f68535241612b27"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Chuyển đổi form
    window.toRegister.onclick = () => { loginForm.classList.add("hidden"); registerForm.classList.remove("hidden"); toRegister.classList.add("hidden"); toLogin.classList.remove("hidden"); title.innerText="Đăng ký"; };
    window.toLogin.onclick = () => { registerForm.classList.add("hidden"); loginForm.classList.remove("hidden"); toLogin.classList.add("hidden"); toRegister.classList.remove("hidden"); title.innerText="Đăng nhập"; };

    // Đăng ký (Khách hàng)
    registerForm.onsubmit = async e => {
        e.preventDefault();
        const email = regEmail.value, pass = regPassword.value;
        try {
            if(pass !== regConfirm.value) throw new Error("Mật khẩu không khớp");
            const cred = await createUserWithEmailAndPassword(auth, email, pass);
            await set(ref(db, "users/" + cred.user.uid), { email, role: "khachhang", createdAt: new Date().toISOString() });
            errorMsg.style.color = "green"; errorMsg.innerText = "Thành công!";
            setTimeout(() => location.reload(), 1000);
        } catch (err) { errorMsg.style.color = "red"; errorMsg.innerText = err.message; }
    };

    // Đăng nhập (Phân quyền)
    loginForm.onsubmit = async e => {
        e.preventDefault();
        try {
            const cred = await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
            const snap = await get(ref(db, "users/" + cred.user.uid));
            const role = snap.exists() ? snap.val().role : "khachhang";
            
            localStorage.setItem("userRole", role);
            if (role === "quanly") location.href = "quanly.html";
            else if (role === "nhanvien") location.href = "nhanvien.html";
            else location.href = "index.html"; // Trang của khách
        } catch (err) { errorMsg.style.color = "red"; errorMsg.innerText = "Sai tài khoản!"; }
    };
</script>
</body>
</html>