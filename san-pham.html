<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªß C√¥ng Vi·ªát - Tinh Hoa Ngh·ªá Nh√¢n</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #d35400; --gold: #b8860b; --dark: #2c3e50; --bg: #fdfaf6; --white: #ffffff; }
        body { font-family: 'Quicksand', sans-serif; margin: 0; background: var(--bg); color: var(--dark); overflow-x: hidden; }

        /* --- NAVBAR --- */
        .navbar { background: #fff; height: 80px; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-family: 'Playfair Display'; font-size: 22px; color: var(--primary); font-weight: bold; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; align-items: center; }
        .nav-item { text-decoration: none; color: var(--dark); font-weight: 700; font-size: 14px; transition: 0.3s; }
        .nav-item:hover { color: var(--primary); }
        .collection-box { padding: 8px 12px; border-radius: 8px; border: 2px solid var(--primary); font-weight: 700; color: var(--primary); outline: none; cursor: pointer; background: white; }

        /* --- GRID & CARD --- */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; padding: 30px 5%; min-height: 50vh; }
        .p-card { background: var(--white); border-radius: 15px; overflow: hidden; border: 1px solid #eee; cursor: pointer; transition: 0.3s; text-align: center; position: relative; }
        .p-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .p-card img { width: 100%; height: 250px; object-fit: cover; }
        .sale-tag { position: absolute; top: 10px; left: 10px; background: #e74c3c; color: white; padding: 4px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; z-index: 5; }
        .p-price { color: var(--primary); font-weight: 800; font-size: 18px; margin: 10px 0; }

        /* --- MODAL CHI TI·∫æT --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 15px; overflow-y: auto; }
        .modal-content { background: #fff; max-width: 1100px; margin: auto; border-radius: 20px; display: grid; grid-template-columns: 1.2fr 1fr; overflow: hidden; position: relative; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-left { background: #1a1a1a; display: flex; flex-direction: column; position: relative; height: 680px; }
        #zoom-viewer { flex: 1; background: #000; }
        .zoom-hint { position: absolute; bottom: 10px; left: 10px; z-index: 5; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 11px; }
        .modal-right { padding: 30px; height: 680px; overflow-y: auto; }

        /* --- CH·ª®NG TH∆Ø POPUP --- */
        #certPopup { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .cert-card { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 100%; position: relative; border: 8px double var(--gold); text-align: center; }
        .cert-card h3 { color: var(--gold); font-family: 'Playfair Display'; font-size: 24px; margin-bottom: 15px; }
        .cert-qr { width: 160px; height: 160px; margin: 20px auto; border: 1px solid #eee; padding: 10px; }

        /* --- INPUTS & BUTTONS --- */
        .btn-cert { background: var(--gold); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; font-size: 13px; }
        .order-input { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; outline: none; font-family: 'Quicksand'; }
        .pay-btn { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; text-align: center; font-weight: 700; }
        .pay-btn.active { border: 2px solid var(--primary); color: var(--primary); background: #fff5eb; }
        .btn-confirm { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 16px; }
        
        /* CSS M·ªõi cho Chi ti·∫øt & S·ªë l∆∞·ª£ng */
        .desc-container { margin: 15px 0; background: #fffaf5; padding: 12px; border-radius: 10px; border-left: 4px solid var(--gold); font-size: 14px; line-height: 1.6; color: #555; }
        .qty-selector { display: flex; align-items: center; gap: 15px; margin: 20px 0; }
        .qty-btn { width: 35px; height: 35px; border: 1px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .qty-btn:hover { background: #f0f0f0; }

        .promo-box { background: #fff5eb; padding: 12px; border-radius: 10px; border: 1px dashed var(--gold); margin: 15px 0; }
        .promo-row { display: flex; gap: 8px; margin-top: 5px; }

        @media (max-width: 900px) { .modal-content { grid-template-columns: 1fr; } .modal-left, .modal-right { height: auto; } #zoom-viewer { height: 350px; } }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="logo"><i class="fas fa-crown"></i> TH·ª¶ C√îNG VI·ªÜT</a>
    <div class="nav-links">
        <a href="index.html" class="nav-item">TRANG CH·ª¶</a>
        <select class="collection-box" id="categoryFilter" onchange="filterProducts()">
            <option value="all">üíé T·∫§T C·∫¢ T√ÅC PH·∫®M</option>
            <option value="G·ªëm s·ª©">üè∫ G·ªëm S·ª©</option>
            <option value="ƒê·ªì g·ªó">ü™µ M·ªπ Ngh·ªá G·ªó</option>
            <option value="M√¢y tre ƒëan">üéã M√¢y Tre</option>
        </select>
        <a href="kiem-tra-don-hang.html" class="nav-item">TRA C·ª®U ƒê∆†N</a>
    </div>
</nav>

<div id="mainGrid" class="product-grid"></div>

<div id="productModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" style="position:absolute; top:15px; right:20px; font-size:30px; cursor:pointer; z-index: 100; color: white; background: rgba(0,0,0,0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</span>
        
        <div class="modal-left">
            <div id="zoom-viewer"></div>
            <div class="zoom-hint"><i class="fas fa-search-plus"></i> Cu·ªôn ƒë·ªÉ soi chi ti·∫øt ngh·ªá nh√¢n</div>
            <div id="map" style="height:150px; margin: 15px; border-radius:10px; border: 2px solid white;"></div>
        </div>

        <div class="modal-right">
            <button class="btn-cert" onclick="openCert()">
                <i class="fas fa-award"></i> XEM NGU·ªíN G·ªêC & CH·ª®NG TH∆Ø
            </button>

            <h2 id="detailTitle" style="margin:0; font-family:'Playfair Display'; color: var(--dark);"></h2>
            
            <div class="desc-container" id="productDesc">
                </div>

            <div class="qty-selector">
                <span style="font-weight: 700; font-size: 14px;">S·ªë l∆∞·ª£ng:</span>
                <button class="qty-btn" onclick="updateQty(-1)">-</button>
                <span id="qtyDisplay" style="font-weight: 700; width: 20px; text-align: center;">1</span>
                <button class="qty-btn" onclick="updateQty(1)">+</button>
            </div>

            <div style="display:flex; gap:10px; margin:15px 0;">
                <div id="btnCOD" class="pay-btn active" onclick="setPay('COD')">Ti·ªÅn m·∫∑t</div>
                <div id="btnQR" class="pay-btn" onclick="setPay('QR')">Qu√©t m√£ QR</div>
            </div>

            <div id="qr-display" style="display:none; text-align:center; margin-bottom: 10px; background:#fffdf9; padding:15px; border:1px dashed var(--gold); border-radius:10px;">
                <p style="margin:0; font-weight:bold; color:#d35400;">CAKE BY VPBANK</p>
                <p style="margin:5px 0; font-size:16px; font-weight:bold;">TR·∫¶N VI·ªÜT ƒê·ª®C</p>
                <img id="qrImg" src="" style="width:140px; height:140px; border: 5px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                <p style="font-size:11px; color:#555; margin-top:5px;">N·ªôi dung: <span id="qrInfo" style="font-weight:bold;"></span></p>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:10px; border: 1px solid #eee;">
                <div style="display:flex; justify-content:space-between;"><span>Gi√° v·∫≠t ph·∫©m:</span><b id="pPrice"></b></div>
                <div style="display:flex; justify-content:space-between; margin:5px 0;"><span>Ph√≠ ship:</span><b>25.000‚Ç´</b></div>
                <div id="promoRowDisplay" style="display:none; justify-content:space-between; color: #27ae60; margin-bottom: 5px;">
                    <span>∆Øu ƒë√£i (<span id="promoPercent">0</span>%):</span><b id="pDiscount">-0‚Ç´</b>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:8px; font-size:20px; color:var(--primary); border-top: 1px dashed #ccc; padding-top: 8px;">
                    <span>T·ªîNG C·ªòNG:</span><b id="pTotal"></b>
                </div>
            </div>

            <div class="promo-box">
                <label style="font-size: 12px; font-weight: 700; color: var(--gold);">M√É ∆ØU ƒê√ÉI</label>
                <div class="promo-row">
                    <input type="text" id="promoInput" class="order-input" style="margin:0;" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°...">
                    <button onclick="applyPromo()" style="background: var(--gold); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">√ÅP D·ª§NG</button>
                </div>
                <div id="promoStatus" style="font-size:12px; margin-top:5px; font-weight:700;"></div>
            </div>

            <input type="text" id="orderName" class="order-input" placeholder="H·ªç t√™n ng∆∞·ªùi nh·∫≠n...">
            <input type="tel" id="orderPhone" class="order-input" placeholder="S·ªë ƒëi·ªán tho·∫°i...">
            <input type="text" id="orderAddress" class="order-input" placeholder="ƒê·ªãa ch·ªâ giao h√†ng ch√≠nh x√°c...">
            
            <button class="btn-confirm" onclick="orderNow()">X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG</button>
        </div>
    </div>
</div>

<div id="certPopup">
    <div class="cert-card">
        <span onclick="closeCert()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px;">&times;</span>
        <i class="fas fa-certificate" style="font-size: 40px; color: var(--gold); margin-bottom: 10px;"></i>
        <h3>CH·ª®NG TH∆Ø NGH·ªÜ NH√ÇN</h3>
        <p style="font-size: 14px; margin-bottom: 5px;">T√°c ph·∫©m: <strong id="certProdName"></strong></p>
        <p style="font-size: 13px; color: #666;">M√£ ƒë·ªãnh danh b·∫£o m·∫≠t: <span id="certId" style="color:var(--gold); font-weight: bold;"></span></p>
        <hr style="border: 0.5px solid #eee; margin: 15px 0;">
        <img id="certQrImg" class="cert-qr" src="">
        <p style="font-size: 12px; font-style: italic; color: #888;">Qu√©t m√£ QR ƒë·ªÉ truy xu·∫•t ngu·ªìn g·ªëc t·∫°i x∆∞·ªüng ngh·ªá nh√¢n</p>
        <div style="margin-top:15px; font-family: 'Playfair Display'; color: var(--gold); font-weight: bold; letter-spacing: 1px;">TINH HOA TH·ª¶ C√îNG VI·ªÜT</div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://thucongviet-system-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let allProducts = [], map = null, currentP = null, dzViewer = null;
    let currentDiscount = 0, appliedPromo = "", currentQty = 1;

    // T·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m
    db.ref('products').on('value', s => {
        allProducts = [];
        s.forEach(c => { let p = c.val(); p.id = c.key; allProducts.push(p); });
        filterProducts(); 
    });

    function formatVND(n){ return new Intl.NumberFormat('vi-VN').format(n)+"‚Ç´"; }

    function openP(p) {
        currentP = p;
        currentDiscount = 0;
        appliedPromo = "";
        currentQty = 1; // Reset s·ªë l∆∞·ª£ng v·ªÅ 1
        
        document.getElementById('promoInput').value = "";
        document.getElementById('promoStatus').innerText = "";
        document.getElementById('promoRowDisplay').style.display = "none";
        document.getElementById('detailTitle').innerText = p.info1;
        document.getElementById('qtyDisplay').innerText = currentQty;

        // Hi·ªÉn th·ªã Chi ti·∫øt s·∫£n ph·∫©m (M√¥ t·∫£ + Ch·∫•t li·ªáu)
        document.getElementById('productDesc').innerHTML = `
            <div style="margin-bottom:5px;"><b>Ch·∫•t li·ªáu:</b> ${p.category}</div>
            <div><b>M√¥ t·∫£:</b> ${p.desc || "T√°c ph·∫©m th·ªß c√¥ng tinh x·∫£o ƒë∆∞·ª£c ch·∫ø t√°c t·ªâ m·ªâ b·ªüi ngh·ªá nh√¢n l√†ng ngh·ªÅ, mang ƒë·∫≠m h·ªìn c·ªët vƒÉn h√≥a Vi·ªát."}</div>
        `;
        
        updatePriceDisplay();
        document.getElementById('productModal').style.display = 'block';
        initDeepZoom(p.img);
        initMap([p.lat || 21.0123, p.lng || 105.9567]);
    }

    // H√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    function updateQty(val) {
        currentQty += val;
        if(currentQty < 1) currentQty = 1;
        document.getElementById('qtyDisplay').innerText = currentQty;
        updatePriceDisplay();
    }

    // X·ª≠ l√Ω Ch·ª©ng th∆∞
    function openCert() {
        alert("D·∫°, h·ªá th·ªëng ƒëang truy xu·∫•t ch·ª©ng th∆∞ b·∫£o m·∫≠t cho t√°c ph·∫©m n√†y...");
        document.getElementById('certProdName').innerText = currentP.info1;
        document.getElementById('certId').innerText = "ID-" + currentP.id.slice(-8).toUpperCase();
        document.getElementById('certQrImg').src = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=VERIFY_PRODUCT_${currentP.id}`;
        document.getElementById('certPopup').style.display = 'flex';
    }

    function closeCert() { document.getElementById('certPopup').style.display = 'none'; }

    // √Åp d·ª•ng m√£ ∆∞u ƒë√£i
    function applyPromo() {
        const code = document.getElementById('promoInput').value.trim().toUpperCase();
        const status = document.getElementById('promoStatus');
        if(!code) return;

        db.ref('promotions').orderByChild('code').equalTo(code).once('value', snap => {
            if(snap.exists()) {
                let promoData;
                snap.forEach(c => { promoData = c.val(); });
                currentDiscount = parseInt(promoData.val);
                appliedPromo = code;
                status.style.color = "#27ae60";
                status.innerText = `‚úÖ ƒê√£ √°p d·ª•ng m√£ ${code} (-${currentDiscount}%)`;
                document.getElementById('promoRowDisplay').style.display = "flex";
                document.getElementById('promoPercent').innerText = currentDiscount;
                updatePriceDisplay();
            } else {
                currentDiscount = 0;
                appliedPromo = "";
                status.style.color = "#e74c3c";
                status.innerText = "‚ùå M√£ kh√¥ng h·ª£p l·ªá.";
                document.getElementById('promoRowDisplay').style.display = "none";
                updatePriceDisplay();
            }
        });
    }

    // C·∫≠p nh·∫≠t gi√° & QR (T√≠nh theo s·ªë l∆∞·ª£ng)
    function updatePriceDisplay() {
        const pricePerUnit = currentP.info2 - (currentP.info2 * (currentP.sale || 0) / 100);
        const subTotal = pricePerUnit * currentQty;
        const discountAmount = (subTotal * currentDiscount) / 100;
        const total = subTotal - discountAmount + 25000;
        const qrCodeText = "TCV" + currentP.id.slice(-5).toUpperCase();

        document.getElementById('pPrice').innerText = formatVND(subTotal);
        document.getElementById('pDiscount').innerText = "-" + formatVND(discountAmount);
        document.getElementById('pTotal').innerText = formatVND(total);
        document.getElementById('qrInfo').innerText = qrCodeText;

        // C·∫≠p nh·∫≠t QR Image v·ªõi s·ªë ti·ªÅn m·ªõi
        document.getElementById('qrImg').src = `https://img.vietqr.io/image/CAKE-0366388104-compact.png?amount=${total}&addInfo=THANH TOAN ${qrCodeText}&accountName=TRAN VIET DUC`;
    }

    function orderNow() {
        const name = document.getElementById('orderName').value.trim();
        const phone = document.getElementById('orderPhone').value.trim();
        const address = document.getElementById('orderAddress').value.trim();
        if(!name || !phone || !address) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin giao h√†ng!");

        const pricePerUnit = currentP.info2 - (currentP.info2 * (currentP.sale || 0) / 100);
        const subTotal = pricePerUnit * currentQty;
        const total = (subTotal - (subTotal * currentDiscount / 100)) + 25000;
        const method = document.getElementById('btnQR').classList.contains('active') ? "Qu√©t m√£ QR" : "Ti·ªÅn m·∫∑t (COD)";

        db.ref('orders').push({
            customer: name, phone: phone, address: address,
            product: currentP.info1, productId: currentP.id,
            quantity: currentQty, // L∆∞u s·ªë l∆∞·ª£ng v√†o DB
            total: total, promoCode: appliedPromo, paymentMethod: method,
            status: "ƒêang ch·ªù x√°c nh·∫≠n", date: new Date().toLocaleString('vi-VN')
        }).then(() => { 
            alert(`ƒê·∫∑t h√†ng th√†nh c√¥ng! B·∫°n ƒë√£ ƒë·∫∑t mua ${currentQty} m√≥n. T·ªïng: ${formatVND(total)}`); 
            closeModal();
        });
    }

    function renderGrid(data) {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = "";
        data.forEach(p => {
            const final = p.info2 - (p.info2 * (p.sale || 0) / 100);
            grid.innerHTML += `
                <div class="p-card" onclick='openP(${JSON.stringify(p)})'>
                    ${p.sale > 0 ? `<div class="sale-tag">-${p.sale}%</div>` : ''}
                    <img src="${p.img}">
                    <div style="padding:15px;">
                        <div style="font-weight:700; height:40px; overflow:hidden;">${p.info1}</div>
                        <div class="p-price">${formatVND(final)}</div>
                    </div>
                </div>`;
        });
    }

    function setPay(t) {
        document.getElementById('btnCOD').className = 'pay-btn '+(t==='COD'?'active':'');
        document.getElementById('btnQR').className = 'pay-btn '+(t==='QR'?'active':'');
        document.getElementById('qr-display').style.display = (t==='QR'?'block':'none');
    }

    function closeModal(){ document.getElementById('productModal').style.display = 'none'; }
    
    function filterProducts() {
        const v = document.getElementById('categoryFilter').value;
        renderGrid(v === 'all' ? allProducts : allProducts.filter(p => p.category === v));
    }

    function initMap(c) {
        setTimeout(() => {
            if(map) map.remove();
            map = L.map('map').setView(c, 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            L.marker(c).addTo(map);
        }, 300);
    }

    function initDeepZoom(url) {
        if (dzViewer) dzViewer.destroy();
        dzViewer = OpenSeadragon({
            id: "zoom-viewer", prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
            tileSources: { type: 'image', url: url },
            gestureSettingsMouse: { clickToZoom: true, scrollToZoom: true }
        });
    }
</script>
</body>
</html>