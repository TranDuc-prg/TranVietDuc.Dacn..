<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá th·ªëng Qu·∫£n tr·ªã ƒê∆°n h√†ng - Th·ªß C√¥ng Vi·ªát</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #d35400; --success: #27ae60; --danger: #e74c3c; --dark: #333; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #fcf9f5; padding: 20px; color: var(--dark); }
        .header-title { text-align: center; color: var(--primary); font-size: 26px; font-weight: bold; margin-bottom: 25px; text-transform: uppercase; }
        
        /* Th·ªëng k√™ */
        .stats-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 15px 40px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; min-width: 150px; }
        .stat-box h3 { margin: 0; font-size: 13px; color: #777; font-weight: normal; }
        .stat-box p { margin: 5px 0 0; font-size: 22px; font-weight: bold; }

        /* B·∫£ng d·ªØ li·ªáu */
        .main-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); max-width: 1150px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #f9f9f9; color: #888; font-size: 12px; text-transform: uppercase; }
        td { padding: 20px 15px; border-bottom: 1px solid #f9f9f9; vertical-align: top; }

        .order-id { background: #eaeded; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 13px; color: #555; }
        .customer-name { color: var(--primary); font-weight: bold; font-size: 15px; }
        .product-price { font-weight: bold; font-size: 18px; margin-bottom: 5px; display: block; color: var(--primary); }
        .product-desc { font-size: 12px; color: #777; line-height: 1.4; }

        /* Badge Tr·∫°ng th√°i */
        .badge { padding: 6px 15px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 8px; }
        .waiting { background: #fef5d9; color: #b7950b; }
        .completed { background: #e8f8f5; color: #1e8449; }
        .cancelled { background: #fdedec; color: #a93226; }

        /* N√∫t b·∫•m */
        .btn-group { display: flex; flex-direction: column; gap: 8px; }
        button { border: none; padding: 9px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; width: 130px; font-size: 12px; }
        .btn-approve { background: var(--primary); color: white; }
        .btn-cancel { background: white; color: #a93226; border: 1px solid #a93226; }
        .cancel-reason { display: block; font-size: 11px; color: var(--danger); margin-top: 5px; font-style: italic; border-left: 2px solid var(--danger); padding-left: 5px; }
    </style>
</head>
<body>

    <div class="header-title">‚öí QU·∫¢N TR·ªä ƒê∆†N H√ÄNG TH·ª¶ C√îNG VI·ªÜT</div>

    <div class="stats-container">
        <div class="stat-box"><h3>T·ªïng ƒë∆°n h√†ng</h3><p id="total-count">0</p></div>
        <div class="stat-box"><h3>ƒêang ch·ªù</h3><p id="pending-count" style="color: #d35400;">0</p></div>
        <div class="stat-box"><h3>Ho√†n th√†nh</h3><p id="done-count" style="color: #27ae60;">0</p></div>
    </div>

    <div class="main-card">
        <table>
            <thead>
                <tr>
                    <th>M√£ ƒë∆°n & Ng√†y</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>S·∫£n ph·∫©m & Gi√° tr·ªã</th>
                    <th>Tr·∫°ng th√°i & Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="order-body">
                <tr><td colspan="4" style="text-align: center; padding: 30px;">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Firebase...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // 1. C·∫•u h√¨nh Firebase
        const config = { databaseURL: "https://thucongviet-system-default-rtdb.firebaseio.com" };
        firebase.initializeApp(config);
        const db = firebase.database();

        // 2. L·∫•y th√¥ng tin User ƒë·ªÉ ph√¢n quy·ªÅn
        const user = JSON.parse(localStorage.getItem("user") || '{"role":"admin","username":"admin"}');
        const role = user.role; 
        const username = user.username;

        // 3. H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá th√¥ng minh (Hi·ªán ƒë√∫ng 1.385.000‚Ç´)
        function formatMoney(order) {
            let amount = order.total || order.totalAmount || order.price || order.itemPrice || order.info2 || 0;
            if (typeof amount === 'string' && (amount.includes('‚Ç´') || amount.includes('ƒë'))) return amount;
            return Number(amount).toLocaleString('vi-VN') + "‚Ç´";
        }

        // 4. T·∫£i v√† hi·ªÉn th·ªã ƒë∆°n h√†ng Realtime
        function loadOrders() {
            db.ref('orders').on('value', (snapshot) => {
                const tbody = document.getElementById("order-body");
                tbody.innerHTML = "";
                const data = snapshot.val();

                if (!data) {
                    tbody.innerHTML = "<tr><td colspan='4' style='text-align: center; padding: 30px;'>Hi·ªán ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</td></tr>";
                    updateStatsDisplay(0, 0, 0);
                    return;
                }

                const ordersArray = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                
                // C·∫≠p nh·∫≠t th·ªëng k√™
                const total = ordersArray.length;
                const pending = ordersArray.filter(o => o.status === "ƒêang ch·ªù x√°c nh·∫≠n" || o.status === "Ch·ªù x·ª≠ l√Ω" || o.status === "M·ªõi").length;
                const done = ordersArray.filter(o => o.status === "ƒê√£ thanh to√°n" || o.status === "Ho√†n th√†nh").length;
                updateStatsDisplay(total, pending, done);

                // L·ªçc ƒë∆°n: Admin xem t·∫•t c·∫£, Kh√°ch xem ƒë∆°n c·ªßa m√¨nh
                let displayData = (role === "admin" || role === "nhanvien") ? ordersArray : ordersArray.filter(o => o.customer === username);

                displayData.reverse().forEach(o => {
                    const tr = document.createElement("tr");
                    const isDone = (o.status === "ƒê√£ thanh to√°n" || o.status === "Ho√†n th√†nh");
                    const isCancelled = (o.status && o.status.toLowerCase().includes("h·ªßy"));

                    let actionHtml = "";
                    if (isDone) {
                        actionHtml = `<span class="badge completed">HO√ÄN TH√ÄNH</span><br><span style="color:#27ae60; font-size:18px; padding-left:35px;">‚úî</span>`;
                    } else if (isCancelled) {
                        actionHtml = `<span class="badge cancelled">ƒê√É H·ª¶Y</span><br><span class="cancel-reason">L√Ω do: ${o.reason || o.cancelReason || 'N/A'}</span>`;
                    } else {
                        actionHtml = `<span class="badge waiting">CH·ªú X·ª¨ L√ù</span><div class="btn-group">`;
                        if (role === "admin" || role === "nhanvien") {
                            actionHtml += `<button class="btn-approve" onclick="verifyAndApprove('${o.id}')">DUY·ªÜT ƒê∆†N</button>`;
                        }
                        actionHtml += `<button class="btn-cancel" onclick="handleCancel('${o.id}')">H·ª¶Y ƒê∆†N</button></div>`;
                    }

                    // M√¥ t·∫£ s·∫£n ph·∫©m
                    let productDetail = o.product || "T√°c ph·∫©m m·ªπ ngh·ªá";
                    if (o.items) productDetail = o.items.map(i => `${i.name} (x${i.quantity})`).join(", ");

                    tr.innerHTML = `
                        <td><span class="order-id">#${o.id.substring(0,8)}</span><br><small style="color:#999">üïí ${o.date || o.time || ''}</small></td>
                        <td><span class="customer-name">${o.customer || 'Kh√°ch v√£ng lai'}</span><br><small style="color:#888">üìç ${o.address || 'Giao t·∫≠n n∆°i'}</small></td>
                        <td>
                            <span class="product-price">${formatMoney(o)}</span>
                            <div class="product-desc">${productDetail}</div>
                        </td>
                        <td>${actionHtml}</td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        // 5. H√†m Duy·ªát ƒë∆°n v·ªõi m·∫≠t kh·∫©u 123
        function verifyAndApprove(id) {
            const password = prompt("X√ÅC NH·∫¨N QU·∫¢N TR·ªä\nVui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ DUY·ªÜT ƒë∆°n h√†ng n√†y:");
            
            if (password === null) return; // Nh·∫•n h·ªßy
            
            if (password === "123") {
                if(confirm("X√°c nh·∫≠n kh√°ch ƒë√£ thanh to√°n v√† duy·ªát ƒë∆°n?")) {
                    db.ref('orders/' + id).update({ 
                        status: "ƒê√£ thanh to√°n",
                        finishDate: new Date().toLocaleString('vi-VN'),
                        confirmedBy: username
                    }).then(() => alert("ƒê√£ duy·ªát ƒë∆°n th√†nh c√¥ng!"));
                }
            } else {
                alert("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c! B·∫°n kh√¥ng c√≥ quy·ªÅn duy·ªát.");
            }
        }

        // 6. H√†m H·ªßy ƒë∆°n k√®m l√Ω do
        function handleCancel(id) {
            const reason = prompt("Vui l√≤ng nh·∫≠p l√Ω do h·ªßy ƒë∆°n (B·∫Øt bu·ªôc):");
            if (reason === null) return;
            if (reason.trim() === "") return alert("B·∫°n ph·∫£i nh·∫≠p l√Ω do m·ªõi c√≥ th·ªÉ h·ªßy!");
            
            db.ref('orders/' + id).update({ 
                status: "ƒê√£ h·ªßy", 
                reason: reason 
            }).then(() => alert("ƒê√£ ghi nh·∫≠n y√™u c·∫ßu h·ªßy ƒë∆°n."));
        }

        function updateStatsDisplay(t, p, d) {
            document.getElementById("total-count").innerText = t;
            document.getElementById("pending-count").innerText = p;
            document.getElementById("done-count").innerText = d;
        }

        document.addEventListener("DOMContentLoaded", loadOrders);
    </script>
</body>
</html>